<!DOCTYPE html>
<html lang="zh-HK">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>AI 測驗產生器 (可保存版)</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --primary-color: #1e88e5;
            --primary-dark: #0d47a1;
            --secondary-color: #6c757d;
            --background-gradient: linear-gradient(135deg, #e0f7fa 0%, #bbdefb 100%);
            --card-background: white;
            --text-color: #333;
            --light-blue-bg: #e3f2fd;
        }

        /* General Styles */
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'PingFang HK', 'Microsoft JhengHei', sans-serif; }
        body { background: var(--background-gradient); color: var(--text-color); min-height: 100vh; padding: 15px; line-height: 1.6; }
        .container { max-width: 800px; margin: 0 auto; }
        .hidden { display: none !important; }

        /* Header */
        header { text-align: center; padding: 10px 0; margin-bottom: 20px; }
        .logo { display: flex; align-items: center; justify-content: center; gap: 12px; }
        .logo i { font-size: 2.8rem; color: var(--primary-color); animation: pulse 2s infinite; }
        @keyframes pulse { 50% { transform: scale(1.1); } }
        h1 { font-size: 2.5rem; color: var(--primary-dark); font-weight: 800; }
        .header-controls { display: flex; justify-content: center; align-items: center; gap: 20px; margin-top: 10px; }

        /* Card */
        .card { background: var(--card-background); border-radius: 16px; box-shadow: 0 6px 20px rgba(0, 0, 0, 0.1); padding: 25px; margin-bottom: 20px; transition: transform 0.3s ease; border-top: 4px solid var(--primary-color); }
        .card:hover { transform: translateY(-5px); }
        .card-title { font-size: 1.6rem; color: var(--primary-color); margin-bottom: 15px; display: flex; align-items: center; gap: 10px; }
        
        /* Buttons */
        .btn { display: inline-block; width: 100%; padding: 12px; background: var(--primary-color); color: white; border: none; border-radius: 50px; font-size: 1.1rem; font-weight: 600; cursor: pointer; transition: all 0.3s ease; box-shadow: 0 3px 10px rgba(30, 136, 229, 0.25); text-align: center; }
        .btn:hover:not(:disabled) { background: var(--primary-dark); transform: translateY(-2px); }
        .btn:disabled { background: #90caf9; cursor: not-allowed; box-shadow: none; transform: none; }
        .btn-secondary { background: var(--secondary-color); }
        .btn-secondary:hover:not(:disabled) { background: #5a6268; }
        .btn-success { background: #28a745; }
        .btn-success:hover:not(:disabled) { background: #218838; }
        .btn-warning { background: #ffc107; color: #212529; }
        .btn-warning:hover:not(:disabled) { background: #e0a800; }
        
        /* Upload Section */
        #upload-section .form-group { margin-bottom: 20px; }
        #upload-section label { display: block; font-weight: 600; margin-bottom: 5px; color: var(--primary-dark); }
        #upload-section input[type="number"] { width: 100%; padding: 10px; border-radius: 8px; border: 2px solid #ddd; font-size: 1rem; }
        .upload-area { border: 3px dashed #42a5f5; border-radius: 16px; padding: 20px; text-align: center; background: rgba(66, 165, 245, 0.08); cursor: pointer; transition: all 0.3s ease; margin-bottom: 20px; }
        .upload-area:hover { background: rgba(66, 165, 245, 0.18); border-color: var(--primary-color); }
        #image-preview-container { display: grid; grid-template-columns: repeat(auto-fill, minmax(120px, 1fr)); gap: 15px; margin-bottom: 20px; }
        .image-preview-item { position: relative; border-radius: 8px; overflow: hidden; box-shadow: 0 2px 8px rgba(0,0,0,0.1); }
        .image-preview-item img { width: 100%; height: 150px; object-fit: cover; display: block; }
        .remove-image-btn { position: absolute; top: 5px; right: 5px; background: rgba(0,0,0,0.6); color: white; border: none; border-radius: 50%; width: 24px; height: 24px; cursor: pointer; display: flex; align-items: center; justify-content: center; font-size: 0.8rem; z-index: 10; }
        .action-buttons { display: grid; grid-template-columns: 1fr; gap: 10px; }
        @media (min-width: 576px) { .action-buttons { grid-template-columns: 1fr 1fr; } }
        
        /* Loading Section */
        #loading-section { text-align: center; padding: 40px 20px; }
        .spinner { border: 5px solid rgba(30, 136, 229, 0.2); border-top: 5px solid var(--primary-color); border-radius: 50%; width: 50px; height: 50px; animation: spin 1.2s linear infinite; margin: 0 auto 20px; }
        @keyframes spin { 100% { transform: rotate(360deg); } }

        /* Quiz & Results Section (Shared Styles) */
        .result-section-title { font-size: 1.4rem; color: var(--primary-dark); border-bottom: 2px solid var(--light-blue-bg); padding-bottom: 8px; margin-top: 30px; margin-bottom: 15px; }
        .review-item { background: var(--light-blue-bg); border-radius: 12px; padding: 15px; margin-bottom: 15px; border-left: 5px solid; }
        .review-item.correct { border-color: #28a745; }
        .review-item.incorrect { border-color: #dc3545; }
        .review-question { font-weight: bold; margin-bottom: 10px; }
        .review-answer, .review-explanation { margin-top: 10px; }
        .review-explanation { font-style: italic; color: #555; }
        
        /* Quiz Section */
        #quiz-progress { font-weight: 600; color: var(--primary-dark); margin-bottom: 15px; text-align: center; background: var(--light-blue-bg); padding: 8px; border-radius: 20px; }
        #question-title-container { display: flex; align-items: center; gap: 15px; margin-bottom: 20px; }
        #listening-indicator { font-size: 1.5rem; color: #ccc; transition: color 0.3s; }
        #listening-indicator.listening { color: #f44336; animation: listening-pulse 1.5s infinite; }
        @keyframes listening-pulse { 0% { transform: scale(1); opacity: 1; } 50% { transform: scale(1.2); opacity: 0.7; } 100% { transform: scale(1); opacity: 1; } }
        #question-text { font-size: 1.25rem; font-weight: 500; flex-grow: 1; }
        .options-container { display: flex; flex-direction: column; gap: 12px; }
        .option-label { display: block; background: var(--light-blue-bg); padding: 15px; border-radius: 12px; cursor: pointer; border: 2px solid transparent; transition: all 0.2s; }
        .option-label:hover { border-color: var(--primary-color); }
        .option-label.selected { background-color: #d1eaff; border-color: var(--primary-dark); font-weight: bold; }
        .option-label.correct { background-color: #d4edda; border-color: #28a745; }
        .option-label.incorrect { background-color: #f8d7da; border-color: #dc3545; }
        .option-label input { display: none; }
        .option-key { font-weight: bold; margin-right: 10px; color: var(--primary-dark); }
        #explanation-panel { background: #fffde7; border: 1px solid #fff9c4; padding: 15px; border-radius: 8px; margin-top: 20px; }
        #quiz-navigation { margin-top: 25px; display: flex; justify-content: space-between; gap: 15px; }

        /* Results Section */
        #overall-score { text-align: center; font-size: 1.8rem; font-weight: bold; color: var(--primary-dark); margin-bottom: 25px; }
        .tag-performance-item { display: flex; align-items: center; margin-bottom: 12px; }
        .tag-name { width: 120px; font-weight: 600; }
        .progress-bar-container { flex-grow: 1; background: #e0e0e0; border-radius: 20px; height: 20px; overflow: hidden; }
        .progress-bar-fill { height: 100%; background: linear-gradient(90deg, #4caf50, #8bc34a); border-radius: 20px; transition: width 0.5s ease-in-out; text-align: right; padding-right: 10px; color: white; font-size: 0.8rem; line-height: 20px; }
        .tag-score { width: 80px; text-align: right; font-weight: 600; }

        /* Voice Mode Toggle */
        .voice-mode-toggle { display: flex; align-items: center; gap: 8px; font-size: 1rem; cursor: pointer; }
        .voice-mode-toggle input:disabled + .slider { background-color: #ccc !important; cursor: not-allowed; }
        .toggle-switch { position: relative; display: inline-block; width: 50px; height: 26px; }
        .toggle-switch input { opacity: 0; width: 0; height: 0; }
        .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #ccc; transition: .4s; border-radius: 26px; }
        .slider:before { position: absolute; content: ""; height: 18px; width: 18px; left: 4px; bottom: 4px; background-color: white; transition: .4s; border-radius: 50%; }
        input:checked + .slider { background-color: var(--primary-color); }
        input:checked + .slider:before { transform: translateX(24px); }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <div class="logo">
                <i class="fas fa-brain"></i>
                <h1>AI 測驗產生器</h1>
            </div>
            <div class="header-controls">
                <label class="voice-mode-toggle">
                    <i class="fas fa-robot"></i>
                    <span>語音模式</span>
                    <div class="toggle-switch">
                        <input type="checkbox" id="voice-mode-checkbox">
                        <span class="slider"></span>
                    </div>
                </label>
            </div>
        </header>

        <!-- Section 1: Upload -->
        <section id="upload-section">
            <div class="card">
                <h2 class="card-title"><i class="fas fa-upload"></i> 新建或導入測驗</h2>
                
                <div class="form-group">
                    <label for="num-questions">生成題目數量</label>
                    <input type="number" id="num-questions" value="10" min="1" max="50">
                </div>

                <div class="form-group">
                    <label for="speech-rate">語音速度 (0.5 - 2)</label>
                    <input type="number" id="speech-rate" value="1.2" min="0.5" max="2" step="0.1">
                </div>
                
                <p>請上傳包含學科知識點的圖片（最多20張）。</p>
                <div class="upload-area" id="upload-area">
                    <i class="fas fa-images fa-2x" style="color: #1e88e5;"></i>
                    <p>點擊此處或拖放圖片到這裡</p>
                    <input type="file" id="image-upload" accept="image/*" multiple style="display: none;">
                </div>

                <div id="image-preview-container"></div>
                
                <div class="action-buttons">
                    <button class="btn btn-warning" id="import-quiz-btn">
                        <i class="fas fa-file-import"></i> 導入測驗 (JSON)
                        <input type="file" id="json-upload" accept=".json" style="display:none;">
                    </button>
                    <button class="btn" id="generate-quiz-btn" disabled>
                        <i class="fas fa-magic"></i> 開始生成測驗
                    </button>
                </div>
            </div>
        </section>

        <!-- Section 2: Loading -->
        <section id="loading-section" class="hidden">
            <div class="card">
                <div class="spinner"></div>
                <h2 id="loading-status">正在準備您的測驗...</h2>
                <p>AI正在努力讀取資料並設計題目，請稍候。</p>
            </div>
        </section>

        <!-- Section 3: Quiz -->
        <section id="quiz-section" class="hidden">
            <div class="card">
                <div id="quiz-progress"></div>
                <div id="question-title-container">
                    <i id="listening-indicator" class="fas fa-microphone-slash"></i>
                    <p id="question-text"></p>
                </div>
                <div class="options-container" id="options-container"></div>
                <div id="explanation-panel" class="hidden"></div>
                <div id="quiz-navigation">
                    <button class="btn btn-secondary" id="prev-question-btn">上一題</button>
                    <button class="btn" id="next-question-btn">下一題</button>
                    <button class="btn btn-success hidden" id="finish-quiz-btn">完成測驗</button>
                </div>
            </div>
        </section>

        <!-- Section 4: Results -->
        <section id="results-section" class="hidden">
            <div class="card">
                <h2 class="card-title"><i class="fas fa-poll"></i> 測驗結果</h2>
                <p id="overall-score"></p>

                <h3 class="result-section-title">各知識領域表現</h3>
                <div id="tag-performance-container"></div>

                <h3 class="result-section-title">題目回顧</h3>
                <div id="review-container"></div>
                
                <div class="action-buttons" style="margin-top: 20px;">
                     <button class="btn btn-warning" id="export-quiz-btn">
                        <i class="fas fa-file-export"></i> 導出測驗 (JSON)
                    </button>
                    <button class="btn" id="restart-btn">
                        <i class="fas fa-redo"></i> 建立新測驗
                    </button>
                </div>
            </div>
        </section>
    </div>

    <script>
        // --- CONFIGURATION ---
        const OPENROUTER_API_KEY = "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";
        const MAX_IMAGES = 20;

        // --- DOM ELEMENTS ---
        const allSections = document.querySelectorAll('section'),
            uploadSection = document.getElementById('upload-section'),
            loadingSection = document.getElementById('loading-section'),
            quizSection = document.getElementById('quiz-section'),
            resultsSection = document.getElementById('results-section'),
            numQuestionsInput = document.getElementById('num-questions'),
            speechRateInput = document.getElementById('speech-rate'),
            uploadArea = document.getElementById('upload-area'),
            imageUpload = document.getElementById('image-upload'),
            imagePreviewContainer = document.getElementById('image-preview-container'),
            generateQuizBtn = document.getElementById('generate-quiz-btn'),
            importQuizBtn = document.getElementById('import-quiz-btn'),
            jsonUpload = document.getElementById('json-upload'),
            loadingStatus = document.getElementById('loading-status'),
            quizProgress = document.getElementById('quiz-progress'),
            questionText = document.getElementById('question-text'),
            optionsContainer = document.getElementById('options-container'),
            quizNavigation = document.getElementById('quiz-navigation'),
            prevQuestionBtn = document.getElementById('prev-question-btn'),
            nextQuestionBtn = document.getElementById('next-question-btn'),
            finishQuizBtn = document.getElementById('finish-quiz-btn'),
            overallScore = document.getElementById('overall-score'),
            tagPerformanceContainer = document.getElementById('tag-performance-container'),
            reviewContainer = document.getElementById('review-container'),
            exportQuizBtn = document.getElementById('export-quiz-btn'),
            restartBtn = document.getElementById('restart-btn'),
            voiceModeCheckbox = document.getElementById('voice-mode-checkbox'),
            listeningIndicator = document.getElementById('listening-indicator'),
            explanationPanel = document.getElementById('explanation-panel');

        // --- APP STATE ---
        let uploadedFiles = [], quizData = [], currentQuestionIndex = 0, ocrText = "", isAnswerRevealed = false;
        
        // --- SPEECH STATE ---
        let isVoiceModeEnabled = false, speechRecognition, isListening = false, cantoneseVoice = null;
        const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;

        // --- INITIALIZATION ---
        function init() {
            uploadArea.addEventListener('click', () => imageUpload.click());
            imageUpload.addEventListener('change', handleFileSelect);
            uploadArea.addEventListener('dragover', (e) => { e.preventDefault(); e.stopPropagation(); uploadArea.style.borderColor = 'var(--primary-dark)'; });
            uploadArea.addEventListener('dragleave', (e) => { e.preventDefault(); e.stopPropagation(); uploadArea.style.borderColor = '#42a5f5'; });
            uploadArea.addEventListener('drop', handleFileDrop);
            generateQuizBtn.addEventListener('click', runQuizGeneration);
            importQuizBtn.addEventListener('click', () => jsonUpload.click());
            jsonUpload.addEventListener('change', handleQuizImport);
            exportQuizBtn.addEventListener('click', handleQuizExport);
            nextQuestionBtn.addEventListener('click', showNextQuestion);
            prevQuestionBtn.addEventListener('click', showPrevQuestion);
            finishQuizBtn.addEventListener('click', showResults);
            restartBtn.addEventListener('click', resetApp);
            voiceModeCheckbox.addEventListener('change', handleVoiceModeToggle);
            const savedQuiz = localStorage.getItem('aiQuizData');
            if (savedQuiz) { quizData = JSON.parse(savedQuiz); showResults(); }
        }

        // --- NEW/REVISED: PERMISSION AND VOICE MODE ACTIVATION ---
        async function handleVoiceModeToggle(e) {
            const isChecked = e.target.checked;
            if (isChecked) {
                await activateVoiceMode();
            } else {
                isVoiceModeEnabled = false;
                if (speechRecognition) stopListening();
            }
        }

        async function activateVoiceMode() {
            // Check for browser support first
            if (!SpeechRecognition || !navigator.mediaDevices) {
                alert("抱歉，您的瀏覽器不支援語音互動所需的功能。");
                voiceModeCheckbox.checked = false;
                return;
            }

            // Use the Permissions API for a robust check
            try {
                const permissionStatus = await navigator.permissions.query({ name: 'microphone' });

                if (permissionStatus.state === 'granted') {
                    console.log("麥克風權限已授予。");
                    isVoiceModeEnabled = true;
                    initSpeechFeatures();
                } else if (permissionStatus.state === 'prompt') {
                    console.log("麥克風權限待請求，現正觸發請求...");
                    // This will trigger the browser's permission prompt.
                    await navigator.mediaDevices.getUserMedia({ audio: true });
                    // If successful, the state will now be 'granted'
                    console.log("權限已成功獲取！");
                    isVoiceModeEnabled = true;
                    initSpeechFeatures();
                } else if (permissionStatus.state === 'denied') {
                    console.error("麥克風權限已被拒絕。");
                    alert("麥克風權限已被瀏覽器封鎖。\n由於您先前曾拒絕過授權，瀏覽器不會再次彈出請求。\n\n請點擊網址列旁的圖示，或進入瀏覽器設定，手動為本站開啟麥克風權限。");
                    isVoiceModeEnabled = false;
                    voiceModeCheckbox.checked = false;
                }
                
                // Watch for future changes in permission
                permissionStatus.onchange = () => {
                    if (permissionStatus.state !== 'granted') {
                        isVoiceModeEnabled = false;
                        voiceModeCheckbox.checked = false;
                        stopListening();
                    }
                };

            } catch (err) {
                console.error("獲取權限狀態時發生錯誤:", err);
                alert("檢查麥克風權限時發生預期外的錯誤，語音模式可能無法使用。");
                isVoiceModeEnabled = false;
                voiceModeCheckbox.checked = false;
            }
        }
        
        // --- SPEECH FEATURES ---
        function initSpeechFeatures() { if (!isVoiceModeEnabled) return; if (speechSynthesis.onvoiceschanged !== undefined) { speechSynthesis.onvoiceschanged = findCantoneseVoice; } findCantoneseVoice(); if (!speechRecognition) { speechRecognition = new SpeechRecognition(); speechRecognition.lang = 'yue-Hant-HK'; speechRecognition.continuous = false; speechRecognition.interimResults = false; speechRecognition.onstart = () => { isListening = true; setListeningState(true); }; speechRecognition.onend = () => { isListening = false; setListeningState(false); if (isVoiceModeEnabled && !isAnswerRevealed && quizSection.classList.contains('hidden') === false) { startListening(); } }; speechRecognition.onerror = (e) => { console.error('Speech recognition error:', e.error); isListening = false; setListeningState(false); }; speechRecognition.onresult = processSpeechResult; } }
        function findCantoneseVoice() { cantoneseVoice = speechSynthesis.getVoices().find(v => v.lang === 'zh-HK' || v.name.toLowerCase().includes('cantonese') || v.name.includes('hiu')); }
        
        function speak(text, onEndCallback) {
            if (!('speechSynthesis' in window)) { if (onEndCallback) onEndCallback(); return; }
            speechSynthesis.cancel();
            const utterance = new SpeechSynthesisUtterance(text);
            if (cantoneseVoice) utterance.voice = cantoneseVoice;
            utterance.lang = 'zh-HK';
            const rate = parseFloat(speechRateInput.value);
            utterance.rate = (!isNaN(rate) && rate >= 0.5 && rate <= 2) ? rate : 1.2;
            utterance.onend = onEndCallback;
            speechSynthesis.speak(utterance);
        }

        function startListening() { if (isVoiceModeEnabled && !isListening && !isAnswerRevealed && speechRecognition) { try { speechRecognition.start(); } catch (e) { console.warn("Recognition could not be started, possibly already active.", e); } } }
        function stopListening() { if (isVoiceModeEnabled && speechRecognition) { isListening = false; speechRecognition.stop(); } }
        function setListeningState(isNowListening) { if (isNowListening) { listeningIndicator.classList.remove('fa-microphone-slash'); listeningIndicator.classList.add('fa-microphone', 'listening'); } else { listeningIndicator.classList.add('fa-microphone-slash'); listeningIndicator.classList.remove('fa-microphone', 'listening'); } }
        
        function processSpeechResult(event) {
            if (!isListening || isAnswerRevealed) return;
            const transcript = event.results[0][0].transcript.trim().toUpperCase().replace(/[.,。]/g, '');
            console.log("Recognized speech:", transcript);

            const words = transcript.split(/\s+/);
            let recognizedAnswer = null;
            const a_triggers = ['A', 'AY', 'ALPHA', '诶'];
            const b_triggers = ['B', 'BEE', 'BRAVO', 'BÌ', 'P'];
            const c_triggers = ['C', 'SEE', 'CHARLIE', 'CÌ'];
            const d_triggers = ['D', 'DEE', 'DELTA', 'DÌ'];

            if (words.some(word => a_triggers.includes(word))) { recognizedAnswer = 'A'; } 
            else if (words.some(word => b_triggers.includes(word))) { recognizedAnswer = 'B'; } 
            else if (words.some(word => c_triggers.includes(word))) { recognizedAnswer = 'C'; } 
            else if (words.some(word => d_triggers.includes(word))) { recognizedAnswer = 'D'; }

            if (recognizedAnswer) { console.log(`Recognized as: ${recognizedAnswer}`); selectAnswer(recognizedAnswer); }
        }

        // --- FILE & DATA HANDLING (Unchanged) ---
        function handleFileSelect(e) { handleFiles(e.target.files); }
        function handleFileDrop(e) { e.preventDefault(); e.stopPropagation(); uploadArea.style.borderColor = '#42a5f5'; handleFiles(e.dataTransfer.files); }
        function handleFiles(files) { const newFiles = Array.from(files).filter(f => f.type.startsWith('image/')); if (uploadedFiles.length + newFiles.length > MAX_IMAGES) { alert(`最多只能上傳 ${MAX_IMAGES} 張圖片。`); return; } uploadedFiles.push(...newFiles); renderImagePreviews(); updateGenerateButtonState(); }
        function renderImagePreviews() { imagePreviewContainer.innerHTML = ''; uploadedFiles.forEach((file, index) => { const reader = new FileReader(); reader.onload = e => { const item = document.createElement('div'); item.className = 'image-preview-item'; item.innerHTML = `<img src="${e.target.result}" alt="${file.name}"><button class="remove-image-btn" data-index="${index}">&times;</button>`; imagePreviewContainer.appendChild(item); }; reader.readAsDataURL(file); }); }
        imagePreviewContainer.addEventListener('click', (e) => { if (e.target.classList.contains('remove-image-btn')) { const indexToRemove = parseInt(e.target.dataset.index, 10); uploadedFiles.splice(indexToRemove, 1); renderImagePreviews(); updateGenerateButtonState(); } });
        function updateGenerateButtonState() { generateQuizBtn.disabled = uploadedFiles.length === 0; }
        function fileToBase64(file) { return new Promise((resolve, reject) => { const reader = new FileReader(); reader.onload = () => resolve(reader.result.split(',')[1]); reader.onerror = reject; reader.readAsDataURL(file); }); }
        function handleQuizImport(e) { const file = e.target.files[0]; if (!file) return; const reader = new FileReader(); reader.onload = (event) => { try { const importedData = JSON.parse(event.target.result); if (importedData && Array.isArray(importedData) && importedData.length > 0 && 'question' in importedData[0]) { quizData = importedData; localStorage.setItem('aiQuizData', JSON.stringify(quizData)); showResults(); } else { throw new Error('Invalid quiz file format.'); } } catch (error) { alert(`導入失敗：${error.message}`); } }; reader.readAsText(file); }
        function handleQuizExport() { if (quizData.length === 0) { alert('沒有可導出的測驗。'); return; } const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(quizData, null, 2)); const downloadAnchorNode = document.createElement('a'); downloadAnchorNode.setAttribute("href", dataStr); downloadAnchorNode.setAttribute("download", `ai-quiz_${new Date().toISOString()}.json`); document.body.appendChild(downloadAnchorNode); downloadAnchorNode.click(); downloadAnchorNode.remove(); }

        // --- API & QUIZ GENERATION (Unchanged) ---
        async function runQuizGeneration() {
            if (uploadedFiles.length === 0) return;
            showSection(loadingSection);
            ocrText = "";
            try {
                loadingStatus.textContent = `步驟 1/3: 正在準備圖片...`;
                const allBase64Images = await Promise.all(uploadedFiles.map(file => fileToBase64(file)));
                loadingStatus.textContent = `步驟 2/3: AI 正在讀取所有圖片內容...`;
                ocrText = await getOcrResult(allBase64Images);
                loadingStatus.textContent = `步驟 3/3: AI 正在生成測驗題目...`;
                const mcqJsonString = await generateMcqs(ocrText, numQuestionsInput.value);
                try {
                    const parsedData = JSON.parse(mcqJsonString);
                    if (!parsedData.questions || !Array.isArray(parsedData.questions) || parsedData.questions.length === 0) { throw new Error("API 未返回有效的題目陣列。"); }
                    quizData = parsedData.questions.map(q => ({ ...q, userAnswer: null, tags: Array.isArray(q.tags) ? q.tags.slice(0, 2) : [] }));
                } catch (e) { console.error("JSON Parsing Error:", e, "Received:", mcqJsonString); throw new Error(`AI 返回的資料格式不正確，無法解析為測驗題目。`); }
                startQuiz();
            } catch (error) { console.error("Quiz Generation Error:", error); alert(`生成測驗時發生錯誤：${error.message}`); resetApp(); }
        }
        async function callApi(prompt, base64Images = []) {
            const modelId = "google/gemini-flash-1.5"; 
            const payload = { model: modelId, messages: [{ role: "user", content: [{ type: "text", text: prompt }] }], max_tokens: 8192 };
            if (base64Images.length > 0) { base64Images.forEach(imgBase64 => { payload.messages[0].content.push({ type: "image_url", image_url: { url: `data:image/jpeg;base64,${imgBase64}` } }); }); } 
            else { payload.response_format = { type: "json_object" }; }
            const response = await fetch("https://openrouter.ai/api/v1/chat/completions", { method: "POST", headers: { "Authorization": `Bearer ${OPENROUTER_API_KEY}`, "Content-Type": "application/json" }, body: JSON.stringify(payload) });
            if (!response.ok) { const errorData = await response.json(); throw new Error(errorData.error?.message || `API請求失敗 (${response.status})`); }
            const data = await response.json(); return data.choices[0].message.content;
        }
        async function getOcrResult(base64Images) { const prompt = "Extract all text from all the provided images accurately. Combine the text from all images into a single response. Output only the raw, combined text."; return await callApi(prompt, base64Images); }
        async function generateMcqs(text, numQuestions) { const prompt = `Based on the following text, create ${numQuestions} multiple-choice questions. **CRITICAL INSTRUCTIONS:** 1.  **DO NOT use phrases like "According to the text", "Based on the passage", etc.** Questions should be standalone. 2.  Each question must have 4 distinct options (A, B, C, D), one correct and three plausible distractors. 3.  Each question must have 1 or 2 relevant 'tags' (e.g., "牛頓定律", "光合作用"). The maximum number of tags is 2. 4.  Each question must have a concise 'explanation' (in Traditional Chinese) explaining the correct answer. 5.  **Format the entire response as a single, valid JSON object** with a single key "questions" which is an array of question objects. 6.  Each object in the array must have keys: \`question\`, \`options\` (can be an object with keys "A", "B", "C", "D" or an array of 4 strings), \`answer\`, \`explanation\`, \`tags\`. 7.  **Your entire output MUST be a single, parsable JSON object. No extra text or markdown.** **Text to use:** --- ${text} ---`; let resultString = await callApi(prompt); const jsonMatch = resultString.match(/```json\s*([\s\S]*?)\s*```/); if (jsonMatch && jsonMatch[1]) { resultString = jsonMatch[1]; } return resultString; }

        // --- QUIZ LOGIC & UI ---
        function showSection(sectionToShow) { allSections.forEach(s => s.classList.add('hidden')); sectionToShow.classList.remove('hidden'); }
        
        function startQuiz() {
            showSection(quizSection);
            currentQuestionIndex = 0;
            if (isVoiceModeEnabled) {
                voiceModeCheckbox.disabled = true;
                quizNavigation.classList.add('hidden');
                runVoiceModeQuestion();
            } else {
                voiceModeCheckbox.disabled = false;
                quizNavigation.classList.remove('hidden');
                displayQuestion();
            }
        }

        function displayQuestion() {
            isAnswerRevealed = false;
            explanationPanel.classList.add('hidden');
            const q = quizData[currentQuestionIndex];
            quizProgress.textContent = `問題 ${currentQuestionIndex + 1} / ${quizData.length}`;
            questionText.textContent = q.question;
            optionsContainer.innerHTML = '';
            const optionKeys = ['A', 'B', 'C', 'D'];
            const optionsIsArray = Array.isArray(q.options);
            optionKeys.forEach((key, index) => {
                const optionText = optionsIsArray ? q.options[index] : q.options[key];
                if (optionText === undefined) return;
                const optionId = `q${currentQuestionIndex}_${key}`;
                const label = document.createElement('label');
                label.className = 'option-label';
                label.htmlFor = optionId;
                label.innerHTML = `<input type="radio" name="q${currentQuestionIndex}" id="${optionId}" value="${key}"><span class="option-key">${key}.</span><span>${optionText}</span>`;
                optionsContainer.appendChild(label);
                if (q.userAnswer === key) { label.querySelector('input').checked = true; label.classList.add('selected'); }
            });
            optionsContainer.querySelectorAll('.option-label').forEach(label => label.addEventListener('click', () => handleManualSelect(label.querySelector('input').value)));
            updateNavigationButtons();
        }

        function handleManualSelect(selectedValue) { if (isAnswerRevealed) return; selectAnswer(selectedValue); }
        
        function selectAnswer(selectedValue) {
            if (isAnswerRevealed) return;
            if (isVoiceModeEnabled) { speechSynthesis.cancel(); stopListening(); }
            quizData[currentQuestionIndex].userAnswer = selectedValue;
            optionsContainer.querySelectorAll('.option-label').forEach(label => { label.classList.remove('selected'); if (label.querySelector('input').value === selectedValue) { label.classList.add('selected'); } });
            checkAnswer(selectedValue);
        }

        function checkAnswer(userAnswer) {
            if (isAnswerRevealed) return; 
            isAnswerRevealed = true;
            const q = quizData[currentQuestionIndex];
            const isCorrect = userAnswer.toUpperCase() === q.answer.toUpperCase();
            optionsContainer.querySelectorAll('.option-label').forEach(label => { const optionKey = label.querySelector('input').value; if (optionKey === q.answer) { label.classList.add('correct'); } else if (optionKey === userAnswer) { label.classList.add('incorrect'); } });
            explanationPanel.innerHTML = `<strong>答案解釋：</strong> ${q.explanation}`;
            explanationPanel.classList.remove('hidden');

            if (isVoiceModeEnabled) {
                const feedbackText = isCorrect ? '答案正確。' : `答案錯誤。正確答案係 ${q.answer}。`;
                const fullFeedback = `${feedbackText} ${q.explanation}`;
                speak(fullFeedback, () => { currentQuestionIndex++; runVoiceModeQuestion(); });
            }
        }

        function updateNavigationButtons() { prevQuestionBtn.disabled = currentQuestionIndex === 0; nextQuestionBtn.classList.toggle('hidden', currentQuestionIndex === quizData.length - 1); finishQuizBtn.classList.toggle('hidden', currentQuestionIndex !== quizData.length - 1); }
        function showNextQuestion() { if (currentQuestionIndex < quizData.length - 1) { currentQuestionIndex++; displayQuestion(); } }
        function showPrevQuestion() { if (currentQuestionIndex > 0) { currentQuestionIndex--; displayQuestion(); } }

        function runVoiceModeQuestion() {
            if (currentQuestionIndex >= quizData.length) { finishVoiceModeQuiz(); return; }
            displayQuestion(); 
            const q = quizData[currentQuestionIndex];
            let textToRead = (currentQuestionIndex === 0) ? "我地而家開始做題目喇。第一條，" : `第 ${currentQuestionIndex + 1} 條，`;
            const optionText = ['A', 'B', 'C', 'D'].map(key => `${getOptionText(q, key)}`).join("。 ");
            textToRead += `${q.question}。 A, ${optionText}`;
            speak(textToRead, startListening);
        }
        
        function finishVoiceModeQuiz() {
            let correctAnswers = quizData.filter(q => q.userAnswer === q.answer).length;
            const finalText = `試卷完成，你嘅分數係 ${correctAnswers} 分，總分 ${quizData.length} 分。詳細評估請睇手機頁面。`;
            speak(finalText, showResults);
        }

        // --- RESULTS LOGIC (Unchanged) ---
        function showResults() { voiceModeCheckbox.disabled = false; showSection(resultsSection); calculateAndDisplayResults(); localStorage.setItem('aiQuizData', JSON.stringify(quizData)); }
        function getOptionText(question, key) { if (!key) return ''; const normalizedKey = key.toUpperCase(); if (Array.isArray(question.options)) { const index = ['A', 'B', 'C', 'D'].indexOf(normalizedKey); return index > -1 && question.options[index] ? question.options[index] : ''; } else { return question.options[normalizedKey] || ''; } }
        function calculateAndDisplayResults() { let correctAnswers = 0; const tagPerformance = {}; quizData.forEach(q => { const isCorrect = q.userAnswer === q.answer; if (isCorrect) correctAnswers++; (q.tags || []).forEach(tag => { if (!tagPerformance[tag]) tagPerformance[tag] = { correct: 0, total: 0 }; tagPerformance[tag].total++; if (isCorrect) tagPerformance[tag].correct++; }); }); const scorePercentage = quizData.length > 0 ? (correctAnswers / quizData.length) * 100 : 0; overallScore.textContent = `總分: ${correctAnswers} / ${quizData.length} (${scorePercentage.toFixed(1)}%)`; tagPerformanceContainer.innerHTML = ''; Object.keys(tagPerformance).forEach(tag => { const data = tagPerformance[tag]; const percentage = (data.correct / data.total) * 100; const item = document.createElement('div'); item.className = 'tag-performance-item'; item.innerHTML = `<span class="tag-name">${tag}</span><div class="progress-bar-container"><div class="progress-bar-fill" style="width: ${percentage}%;">${percentage.toFixed(0)}%</div></div><span class="tag-score">${data.correct} / ${data.total}</span>`; tagPerformanceContainer.appendChild(item); }); reviewContainer.innerHTML = ''; quizData.forEach((q, index) => { const isCorrect = q.userAnswer === q.answer; const item = document.createElement('div'); item.className = `review-item ${isCorrect ? 'correct' : 'incorrect'}`; let userAnswerText = q.userAnswer ? `${q.userAnswer}. ${getOptionText(q, q.userAnswer)}` : '未作答'; let answerHtml = `<div class="review-answer">你的答案: ${userAnswerText} ${isCorrect ? '✔' : '❌'}</div>`; if (!isCorrect) { let correctAnswerText = `${q.answer}. ${getOptionText(q, q.answer)}`; answerHtml += `<div class="review-answer">正確答案: ${correctAnswerText}</div>`; } item.innerHTML = `<div class="review-question">Q${index + 1}: ${q.question}</div>${answerHtml}<div class="review-explanation"><strong>解釋:</strong> ${q.explanation}</div>`; reviewContainer.appendChild(item); }); }
        
        // --- APP RESET (Unchanged) ---
        function resetApp() { localStorage.removeItem('aiQuizData'); uploadedFiles = []; quizData = []; currentQuestionIndex = 0; ocrText = ""; isAnswerRevealed = false; if (speechSynthesis) speechSynthesis.cancel(); if (speechRecognition) speechRecognition.abort(); imagePreviewContainer.innerHTML = ''; updateGenerateButtonState(); showSection(uploadSection); imageUpload.value = ''; jsonUpload.value = ''; voiceModeCheckbox.disabled = false; quizNavigation.classList.remove('hidden'); }

        // --- START APP ---
        document.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>