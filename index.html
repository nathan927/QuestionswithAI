<!DOCTYPE html>
<html lang="zh-HK">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>AI 知識點測驗與試卷產生器 (專業穩定版)</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --primary-color: #1e88e5;
            --primary-dark: #0d47a1;
            --secondary-color: #6c757d;
            --success-color: #28a745;
            --success-dark: #1e7e34;
            --background-gradient: linear-gradient(135deg, #e0f7fa 0%, #bbdefb 100%);
            --card-background: white;
            --text-color: #333;
            --light-blue-bg: #e3f2fd;
        }
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'PingFang HK', 'Microsoft JhengHei', sans-serif; }
        body { background: var(--background-gradient); color: var(--text-color); min-height: 100vh; padding: 15px; line-height: 1.6; }
        .container { max-width: 800px; margin: 0 auto; }
        .hidden { display: none !important; }
        header { text-align: center; padding: 10px 0; margin-bottom: 20px; }
        h1 { font-size: 2.5rem; color: var(--primary-dark); font-weight: 800; }
        .card { background: var(--card-background); border-radius: 16px; box-shadow: 0 6px 20px rgba(0, 0, 0, 0.1); padding: 25px; margin-bottom: 20px; transition: transform 0.3s ease; border-top: 4px solid var(--primary-color); }
        .card:hover { transform: translateY(-5px); }
        .card-title { font-size: 1.6rem; color: var(--primary-color); margin-bottom: 15px; display: flex; align-items: center; gap: 10px; }
        
        #generation-card {
            margin-top: 30px;
            padding: 30px;
            border-top-color: var(--success-dark);
            background: linear-gradient(135deg, #f8f9fa, #e9ecef);
        }
        #generation-card .card-title { color: var(--success-dark); }
        
        .btn { display: inline-flex; align-items: center; justify-content: center; gap: 8px; width: 100%; padding: 14px; background: var(--primary-color); color: white; border: none; border-radius: 50px; font-size: 1.15rem; font-weight: 600; cursor: pointer; transition: all 0.3s ease; box-shadow: 0 4px 12px rgba(30, 136, 229, 0.25); text-align: center; }
        .btn:hover:not(:disabled) { background: var(--primary-dark); transform: translateY(-2px); box-shadow: 0 6px 16px rgba(13, 71, 161, 0.3); }
        .btn:disabled { background: #90caf9; cursor: not-allowed; box-shadow: none; transform: none; }
        .btn-success { background: var(--success-color); box-shadow: 0 4px 12px rgba(40, 167, 69, 0.25); }
        .btn-success:hover:not(:disabled) { background: var(--success-dark); box-shadow: 0 6px 16px rgba(30, 126, 52, 0.3); }
        .form-group { margin-bottom: 20px; }
        label { display: block; font-weight: 600; margin-bottom: 5px; color: var(--primary-dark); }
        select, input[type="number"] { width: 100%; padding: 10px; border-radius: 8px; border: 2px solid #ddd; font-size: 1rem; }
        .tab-container { display: flex; border: 1px solid var(--primary-color); border-radius: 50px; overflow: hidden; margin-bottom: 25px; }
        .tab-btn { flex: 1; padding: 12px 15px; cursor: pointer; background: transparent; border: none; font-size: 1.05rem; font-weight: 600; color: var(--primary-color); text-align: center; transition: all 0.3s ease; display: flex; align-items: center; justify-content: center; gap: 8px; }
        .tab-btn.active { background-color: var(--primary-color); color: white; box-shadow: inset 0 2px 4px rgba(0,0,0,0.1); }
        .tab-content { padding-top: 10px; }
        .upload-area { border: 3px dashed #42a5f5; border-radius: 16px; padding: 20px; text-align: center; background: rgba(66, 165, 245, 0.08); cursor: pointer; transition: all 0.3s ease; margin-bottom: 20px; }
        .upload-area:hover { background: rgba(66, 165, 245, 0.18); border-color: var(--primary-color); }
        .upload-area i { color: #1e88e5; }
        #image-preview-container { display: grid; grid-template-columns: repeat(auto-fill, minmax(120px, 1fr)); gap: 15px; margin-bottom: 20px; }
        .image-preview-item { position: relative; border-radius: 8px; overflow: hidden; box-shadow: 0 2px 8px rgba(0,0,0,0.1); }
        .image-preview-item img { width: 100%; height: 150px; object-fit: cover; display: block; }
        .remove-image-btn { position: absolute; top: 5px; right: 5px; background: rgba(0,0,0,0.6); color: white; border: none; border-radius: 50%; width: 24px; height: 24px; cursor: pointer; display: flex; align-items: center; justify-content: center; font-size: 0.8rem; z-index: 10; }
        .knowledge-point-selectors { display: grid; grid-template-columns: 1fr; gap: 20px; margin-bottom: 20px; }
        @media (min-width: 576px) { .knowledge-point-selectors { grid-template-columns: 1fr 1fr; } }
        .kp-container { border: 1px solid #ddd; border-radius: 8px; padding: 15px; height: 320px; overflow-y: auto; background: #fafafa; }
        .kp-container h4 { margin: 0 0 10px 0; border-bottom: 1px solid #eee; padding-bottom: 5px; color: var(--primary-dark); position: sticky; top: -15px; background: #fafafa; z-index: 1; }
        #kp-grade-container { display: flex; flex-wrap: wrap; gap: 10px; padding: 10px; background-color: var(--light-blue-bg); border-radius: 8px; margin-bottom: 20px; }
        .grade-label { display: block; font-weight: normal; cursor: pointer; background-color: white; padding: 5px 12px; border-radius: 20px; border: 1px solid #ddd; transition: all 0.2s ease; }
        .grade-label input { display: none; }
        .grade-label.checked { background-color: var(--primary-color); color: white; border-color: var(--primary-dark); }
        .kp-grade-heading { font-size: 1rem; font-weight: bold; color: var(--primary-dark); margin: 15px 0 5px 0; padding-left: 5px; border-left: 3px solid var(--primary-color); }
        .kp-grade-heading:first-child { margin-top: 0; }
        .kp-label { display: block; margin-bottom: 8px; font-weight: normal; cursor: pointer; padding-left: 5px; }
        .kp-label input { margin-right: 8px; }
        #q-type-requirements { margin-top: 25px; }
        .q-type-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 15px; }
        .q-type-item { display: flex; align-items: center; gap: 10px; background: #fff; padding: 10px; border-radius: 8px; border: 1px solid #ddd; }
        .q-type-item label { flex-grow: 1; margin-bottom: 0; }
        .q-type-item input[type="number"] { width: 60px; text-align: center; }
        .q-type-item.template-item { background-color: var(--light-blue-bg); border-color: var(--primary-color); }
        .q-type-item.disabled { background-color: #f1f1f1; color: #aaa; cursor: not-allowed; }
        .q-type-item.disabled label, .q-type-item.disabled input { cursor: not-allowed; }
        .action-buttons { display: grid; grid-template-columns: 1fr; gap: 15px; }
        @media (min-width: 576px) { .action-buttons { grid-template-columns: 1fr 1fr; } }
        #loading-section { text-align: center; padding: 40px 20px; }
        .spinner { border: 5px solid rgba(30, 136, 229, 0.2); border-top: 5px solid var(--primary-color); border-radius: 50%; width: 50px; height: 50px; animation: spin 1.2s linear infinite; margin: 0 auto 20px; }
        @keyframes spin { 100% { transform: rotate(360deg); } }
        .result-section-title { font-size: 1.4rem; color: var(--primary-dark); border-bottom: 2px solid var(--light-blue-bg); padding-bottom: 8px; margin-top: 30px; margin-bottom: 15px; }
        .review-item { background: var(--light-blue-bg); border-radius: 12px; padding: 15px; margin-bottom: 15px; border-left: 5px solid; }
        .review-item.correct { border-color: #28a745; }
        .review-item.incorrect { border-color: #dc3545; }
        .review-question { font-weight: bold; margin-bottom: 10px; }
        .review-answer, .review-explanation { margin-top: 10px; }
        .review-explanation { font-style: italic; color: #555; }
        #quiz-progress { font-weight: 600; color: var(--primary-dark); margin-bottom: 15px; text-align: center; background: var(--light-blue-bg); padding: 8px; border-radius: 20px; }
        #question-text { font-size: 1.25rem; font-weight: 500; flex-grow: 1; margin-bottom: 20px; }
        .options-container { display: flex; flex-direction: column; gap: 12px; }
        .option-label { display: block; background: var(--light-blue-bg); padding: 15px; border-radius: 12px; cursor: pointer; border: 2px solid transparent; transition: all 0.2s; }
        .option-label.selected { background-color: #d1eaff; border-color: var(--primary-dark); font-weight: bold; }
        .option-label.correct { background-color: #d4edda; border-color: #28a745; }
        .option-label.incorrect { background-color: #f8d7da; border-color: #dc3545; }
        .option-label input { display: none; }
        .option-key { font-weight: bold; margin-right: 10px; color: var(--primary-dark); }
        #explanation-panel { background: #fffde7; border: 1px solid #fff9c4; padding: 15px; border-radius: 8px; margin-top: 20px; }
        #quiz-navigation { margin-top: 25px; display: flex; justify-content: space-between; gap: 15px; }
        #overall-score { text-align: center; font-size: 1.8rem; font-weight: bold; color: var(--primary-dark); margin-bottom: 25px; }
        footer { text-align: center; padding: 20px 0; margin-top: 40px; color: var(--secondary-color); font-size: 0.9rem; }
    </style>
</head>
<body>
    <div class="container">
        <header><h1>AI 知識點測驗與試卷產生器</h1></header>

        <section id="config-section">
            <div class="card">
                <h2 class="card-title"><i class="fas fa-cogs"></i> 步驟一：設定考試範圍</h2>
                <div class="tab-container">
                    <button class="tab-btn active" data-tab="upload-materials"><i class="fas fa-upload"></i>上傳資料模式</button>
                    <button class="tab-btn" data-tab="select-knowledge-points"><i class="fas fa-check-square"></i>知識點模式</button>
                </div>
                <div id="tab-content-upload-materials" class="tab-content">
                    <p>上傳圖片作為考試範圍。適用於根據特定教材、筆記或舊試卷出題。</p>
                    <div class="upload-area" id="upload-area"><i class="fas fa-images fa-2x"></i><p>點擊此處或拖放圖片到這裡 (最多20張)</p><input type="file" id="image-upload" accept="image/*" multiple style="display: none;"></div>
                    <div id="image-preview-container"></div>
                </div>
                <div id="tab-content-select-knowledge-points" class="tab-content hidden">
                     <p>直接從課程大綱選擇知識點作為考試範圍，AI 將據此生成題目。</p>
                     <div class="form-group"><label for="kp-subject">學科</label><select id="kp-subject"></select></div>
                    <div class="form-group"><label>年級 (可多選)</label><div id="kp-grade-container"></div></div>
                    <div class="knowledge-point-selectors">
                        <div class="kp-container" id="kp-major-container"><h4>知識點 (大類)</h4><div id="kp-major-checkboxes"></div></div>
                        <div class="kp-container" id="kp-minor-container"><h4>知識點 (細項)</h4><div id="kp-minor-checkboxes"></div></div>
                    </div>
                </div>
            </div>

            <div class="card" id="generation-card">
                 <h2 class="card-title"><i class="fas fa-magic"></i> 步驟二：生成內容</h2>
                 <div id="q-type-requirements">
                    <label style="font-size: 1.2rem; margin-bottom: 15px;">題型要求</label>
                    <div class="q-type-grid">
                        <div class="q-type-item template-item"><input type="checkbox" id="chk-math-template"><label for="chk-math-template">使用數學試卷模板</label></div>
                        <div class="q-type-item template-item"><input type="checkbox" id="chk-putonghua-template"><label for="chk-putonghua-template">使用普通話試卷模板</label></div>
                        <div class="q-type-item" id="item-single-choice"><input type="checkbox" id="chk-single-choice"><label for="chk-single-choice">單項選擇題</label><input type="number" id="num-single-choice" value="5" min="0"></div>
                        <div class="q-type-item" id="item-multi-choice"><input type="checkbox" id="chk-multi-choice"><label for="chk-multi-choice">多項選擇題</label><input type="number" id="num-multi-choice" value="3" min="0"></div>
                        <div class="q-type-item" id="item-fill-blank"><input type="checkbox" id="chk-fill-blank"><label for="chk-fill-blank">空白填充題</label><input type="number" id="num-fill-blank" value="5" min="0"></div>
                         <div class="q-type-item" id="item-matching"><input type="checkbox" id="chk-matching"><label for="chk-matching">配對題</label><input type="number" id="num-matching" value="1" min="0"></div>
                         <div class="q-type-item" id="item-short-answer"><input type="checkbox" id="chk-short-answer"><label for="chk-short-answer">問答題</label><input type="number" id="num-short-answer" value="2" min="0"></div>
                         <div class="q-type-item" id="item-true-false"><input type="checkbox" id="chk-true-false"><label for="chk-true-false">是非題</label><input type="number" id="num-true-false" value="5" min="0"></div>
                    </div>
                 </div>
                <div class="action-buttons" style="margin-top:30px;">
                    <button class="btn" id="generate-quiz-btn" disabled><i class="fas fa-bolt"></i> 生成互動測驗</button>
                    <button class="btn btn-success" id="generate-exam-btn" disabled><i class="fas fa-file-alt"></i> 生成模擬試卷</button>
                </div>
            </div>
        </section>

        <!-- All other sections are hidden by default -->
        <section id="quiz-section" class="hidden">...</section>
        <section id="results-section" class="hidden">...</section>
        <section id="loading-section" class="hidden">...</section>
        <section id="exam-result-section" class="hidden">...</section>
        
        <footer>Designed by Nathan Yuen. All Rights Reserved.</footer>
    </div>

    <script>
        const KNOWLEDGE_POINTS = {
            Math: {
                P1: {"數範疇": ["100以內的數(數、讀、寫)", "單數與雙數", "數序與比較", "20以內加法", "20以內減法"], "圖形與空間範疇": ["基本平面圖形(圓、三角、正方、長方)", "基本立體圖形(球、正方、長方、圓柱)", "長度和距離的直接比較"], "度量範疇": ["香港流通貨幣(元、角)", "星期與日期", "閱讀鐘面(小時)"], "應用題": ["一步加減法應用題"]},
                P2: {"數範疇": ["1000以內的數(讀、寫、位值)", "乘法概念(重複加)", "乘法口訣(2,3,4,5,10)", "除法概念(均分、包含)", "三位數加法(進位)", "三位數減法(退位)"], "圖形與空間範疇": ["直線與曲線", "四個方向(上、下、左、右)"], "度量範疇": ["長度單位(厘米、米)", "重量單位(克、公斤)", "閱讀鐘面(時、分)"], "數據處理範疇": ["象形圖(一對一)"]},
                P3: {"數範疇": ["萬以內的數", "乘法(一位乘兩/三位)", "除法(一位除兩/三位)", "加減混合計算", "乘加、乘減混合計算", "分數概念(部分與整體)", "同分母分數比較", "一位小數"], "圖形與空間範疇": ["角與直角", "平行線與垂直線", "三角形(等邊、等腰、直角)", "四邊形(正方形、長方形、平行四邊形、菱形、梯形)"], "度量範疇": ["容量單位(毫升、升)", "時間單位(秒)", "24小時報時制"], "應用題": ["兩步混合運算應用題"]},
                P4: {"數範疇": ["大數(億)", "乘法(兩位乘兩/三位)", "除法(兩位除三位)", "四則運算(括號的應用)", "分數加減(同分母)", "小數加減"], "圖形與空間範疇": ["對稱圖形與對稱軸", "圖形的旋轉", "多邊形"], "度量範疇": ["周界(正方形、長方形)", "面積(正方形、長方形)", "面積單位(平方厘米、平方米)"], "數據處理範疇": ["棒形圖(一對多)"]},
                P5: {"數範疇": ["因數與倍數", "公因數與最大公因數(HCF)", "公倍數與最小公倍數(LCM)", "分數乘法", "分數除法", "小數乘法", "小數除法", "異分母分數加減"], "圖形與空間範疇": ["圓的認識(圓心、半徑、直徑)", "立體圖形(正方體、長方體)", "體積概念與計算", "坐標(第一象限)"], "代數範疇": ["簡易方程(用x表示未知數)"], "數據處理範疇": ["複合棒形圖", "折線圖"]},
                P6: {"數範疇": ["百分數與分數、小數互化", "百分數應用(折扣、百分率)", "簡易利息", "比和比率"], "圖形與空間範疇": ["圓的周界", "圓的面積", "速率", "立體圖形(續)"], "代數範疇": ["方程的應用"], "數據處理範疇": ["圓面積圖"]},
                S1: {"數與代數": ["有向數與數線", "有向數的四則運算", "代數式的建立與化簡", "代數式的多項式", "一元一次方程的解法", "百分法(I)(百分數增減、盈利虧損、折扣)"], "度量、圖形與空間": ["幾何學簡介(點、線、面)", "角與相交線、平行線", "三角形的角", "多邊形的角", "對稱與變換(反射、旋轉)", "坐標系簡介", "面積和體積(I)"], "數據處理": ["統計圖表的介紹與闡釋(棒形圖、折線圖、圓面積圖)", "集中趨勢的度量(平均數、眾數、中位數)"]},
                S2: {"數與代數": ["指數定律(正整數指數)", "代數恆等式", "多項式的乘法", "因式分解(提取公因式、十字相乘)", "一元一次不等式", "比率與比例", "續指數定律(零及負指數)"], "度量、圖形與空間": ["全等三角形與相似三角形", "畢氏定理", "演繹幾何(三角形)", "面積和體積(II)(柱體、錐體)", "三角比的認識(sin, cos, tan)", "三角比的應用(仰角、俯角)"], "數據處理": ["概率的基本概念"]},
                S3: {"數與代數": ["因式分解(續)", "分數代數式與公式", "聯立二元一次方程", "二次方程(因式分解法、圖像法)", "續百分法(續增長、續虧損)", "數系的認識"], "度量、圖形與空間": ["圓的基本性質(弦、弧、角)", "軌跡", "直線的坐標幾何(距離、斜率、中點)", "三角學的應用(二維空間)"], "數據處理": ["數據離差的度量(分佈域、四分位數間距、標準差)"]},
                S4: {"必修-函數與圖像": ["二次函數的圖像與性質", "函數的變換"], "必修-數與代數": ["續二次方程(公式法、判別式)", "指數函數與對數函數(I)"], "必修-度量、圖形與空間": ["續圓的性質(圓內接四邊形、切線)", "求積法(不規則圖形)", "三角學(正弦公式、餘弦公式)"], "必修-數據處理": ["排列與組合", "續概率(條件概率、獨立事件)"]},
                S5: {"必修-數與代數": ["等差數列與等比數列", "線性規劃"], "必修-度量、圖形與空間": ["向量(二維)", "三維空間的坐標與向量", "直線與平面的方程", "三角學的應用(三維空間)"], "必修-數據處理": ["期望值", "概率分佈(二項分佈、幾何分佈)"], "選修M1-微積分": ["極限與連續性", "導數的定義與計算", "導數的應用(極值、變化率)"], "選修M2-代數與微積分": ["矩陣與行列式", "向量(三維)", "數學歸納法"]},
                S6: {"必修-總複習": ["各單元綜合應用", "DSE應試策略"], "選修M1-微積分": ["定積分與面積", "積分技巧"], "選修M2-代數與微積分": ["三角學(和差角公式)", "反三角函數", "微積分(續)"]}
            },
            Chinese: {
                P1: {"識字與寫字": ["基本筆畫與筆順", "獨體字結構", "常用部首(人、口、女、山等)", "量詞配對"], "閱讀": ["閱讀短詩", "閱讀單句和短段", "理解標示(公園、交通)"], "寫作": ["仿作單句", "看圖寫詞語和單句"], "語文基礎": ["配詞", "反義詞", "問候語"]},
                P2: {"識字與寫字": ["合體字結構(上下、左右)", "形近字辨析", "同音字辨析"], "閱讀": ["閱讀寓言故事", "閱讀生活故事"], "寫作": ["句子擴寫", "看圖寫幾句話"], "語文基礎": ["關聯詞(和、跟、同)", "認識主語和謂語", "簡單標點(句號、逗號)"]},
                P3: {"閱讀": ["記敍文(記人)", "說明文(事物)", "童話故事", "理解段落大意"], "寫作": ["記敍一件簡單的事", "實用文(便條)", "描寫天氣"], "語文基礎": ["標點符號(問號、感嘆號)", "修辭(比喻、擬人)", "成語(動物、數字)"]},
                P4: {"閱讀": ["記敍文(記事)", "說明文(事理)", "古代神話故事", "找出中心思想"], "寫作": ["記敍文(按時序)", "實用文(書信)", "描寫景物"], "語文基礎": ["關聯詞(因果、轉折)", "句子類型(陳述、疑問、祈使、感嘆)", "修改病句(成分殘缺)"]},
                P5: {"閱讀": ["抒情文(借物抒情)", "議論文(初步認識論點)", "古典詩歌(唐詩絕句)", "理解作者思想感情"], "寫作": ["複雜記敍文(場景描寫)", "實用文(通告)", "說明事物"], "語文基礎": ["修辭(排比、誇張、設問)", "關聯詞(假設、條件)", "文言詞彙(之、曰、以)"]},
                P6: {"閱讀": ["小說單元(人物形象)", "新聞報道", "文言文入門(寓言)", "歸納主旨"], "寫作": ["想像作文", "實用文(演講稿)", "議論一件簡單事情"], "語文基礎": ["綜合運用", "句子仿作", "文言句式(判斷句、被動句)"]},
                S1: {"閱讀理解": ["記敍的要素與方法(順敍、倒敍、插敍)", "說明文的層次與方法(分類、定義)", "描寫文的技巧(定點、動點)", "文言文選讀(寓言、筆記小說)"], "寫作訓練": ["記敍抒情文", "描寫文(人物肖像、景物)", "實用文(建議書)"], "語文基礎": ["詞類(實詞、虛詞)", "句子成分(主謂賓定狀補)", "修辭(對比、反復、對偶)"]},
                S2: {"閱讀理解": ["小說的情節、人物與環境", "議論文的論點、論據與論證", "抒情文的直接與間接抒情", "文言文選讀(傳記、遊記)"], "寫作訓練": ["說明文(事理)", "議論文(單一論點立論)", "實用文(新聞稿)"], "語文基礎": ["複句類型(並列、承接、轉折、因果等)", "文言虛詞(之、乎、者、也、其、且)"]},
                S3: {"閱讀理解": ["散文的線索與主旨", "比較閱讀(主旨、作法)", "古典詩詞曲(唐詩律詩、宋詞、元曲)", "文言文選讀(論說、小品)"], "寫作訓練": ["議論文(駁論)", "開放式題型寫作(多角度思考)"], "文學文化": ["作家專題(如魯迅、金庸)", "中國文化專題(節日、建築、飲食)"]},
                S4: {"DSE-閱讀": ["論說文的論證方法分析", "小說的象徵與諷刺手法", "中國古典戲曲簡介", "文言文(先秦諸子散文)"], "DSE-寫作": ["多角度評論", "記敍與議論結合", "材料寫作"], "DSE-聆聽與綜合": ["整合不同材料(文字、圖表)", "撰寫實用文(書信、演講辭)"], "DSE-文學": ["文學流派(現實、浪漫)", "文化專題(儒家、道家思想)"]},
                S5: {"DSE-閱讀": ["中國現當代文學作品選讀(小說、散文)", "文言文(史傳文學如《史記》)", "文學評論入門"], "DSE-寫作": ["專題寫作(社會議題)", "文化評論"], "DSE-聆聽與綜合": ["比較資料及辨析觀點", "撰寫實用文(報告、建議書)"], "DSE-文學": ["香港文學", "比較文學(中西作品比較)"]},
                S6: {"DSE-綜合訓練": ["卷一(閱讀)應試策略", "卷二(寫作)審題立意", "卷三(綜合)答題框架", "卷四(說話)口語溝通技巧"], "DSE-精讀": ["指定文言篇章精讀", "經典文學篇章深度分析"], "DSE-文化": ["文化傳承與創新", "當代社會文化議題探討"]}
            },
            English: {
                P1: {"Phonics": ["Letter sounds (a-z)"], "Grammar": ["'a/an'", "Singular nouns", "Personal pronouns (I/you/he/she)"], "Vocabulary": ["Colours", "Toys", "Body parts"], "Reading & Writing": ["Reading simple sentences", "Writing simple words"]},
                P2: {"Phonics": ["Short vowels"], "Grammar": ["Present tense (am/is/are)", "Plural nouns (-s/-es)", "'this/that/these/those'"], "Vocabulary": ["Animals", "Food", "School items"], "Reading & Writing": ["Reading short paragraphs", "Writing simple sentences"]},
                P3: {"Grammar": ["Present continuous tense", "Past tense (was/were)", "Prepositions of place (in/on/under)"], "Vocabulary": ["Jobs", "Places in town", "Weather"], "Reading & Writing": ["Reading simple stories", "Answering wh-questions"]},
                P4: {"Grammar": ["Simple past tense (regular/irregular verbs)", "Future tense (will)", "Adjectives (comparative)"], "Vocabulary": ["Hobbies", "Festivals", "Transport"], "Reading & Writing": ["Understanding main ideas", "Writing a short paragraph"]},
                P5: {"Grammar": ["Present perfect tense", "Adjectives (superlative)", "Adverbs of manner"], "Vocabulary": ["Sports", "Countries", "Feelings"], "Reading & Writing": ["Identifying specific information", "Writing a simple diary entry"]},
                P6: {"Grammar": ["Passive voice (simple present/past)", "Reported speech (simple statements)", "Conjunctions"], "Vocabulary": ["Environment", "Technology", "Health"], "Reading & Writing": ["Inferencing", "Writing a short story"]},
                S1: {"Grammar Focus": ["Tenses review (simple present/past, continuous, future)", "Nouns (countable/uncountable)", "Articles", "Prepositions of time and place"], "Vocabulary Building": ["School life", "Festivals and celebrations", "Personalities"], "Reading Skills": ["Skimming and scanning", "Identifying main ideas in paragraphs"], "Writing Skills": ["Personal introduction", "Descriptive paragraph (people/places)"]},
                S2: {"Grammar Focus": ["Present perfect vs. past simple", "Modals (can/should/must)", "Conditionals (Type 0 & 1)", "Relative clauses (who/which/that)"], "Vocabulary Building": ["Travel and holidays", "Food and culture", "Environmental issues"], "Reading Skills": ["Guessing meaning from context", "Understanding text organization"], "Writing Skills": ["Narrative writing (a past event)", "Informal letter/email"]},
                S3: {"Grammar Focus": ["Past perfect tense", "Passive voice (more tenses)", "Reported speech (questions/commands)", "Gerunds and infinitives"], "Vocabulary Building": ["Technology and innovation", "Social issues", "The arts"], "Reading Skills": ["Distinguishing fact from opinion", "Making inferences"], "Writing Skills": ["Argumentative writing (for/against)", "Formal letter (application/complaint)"]},
                S4: {"DSE-Grammar": ["Advanced tenses review", "Complex sentence structures", "Conditionals (Type 2 & 3)", "Mixed conditionals"], "DSE-Reading": ["Analyzing literary devices", "Reading news articles and editorials", "Tone and Attitude"], "DSE-Writing": ["Expository essays", "Short stories with plot development", "Discursive essays"], "DSE-Speaking": ["Group discussions on current affairs"]},
                S5: {"DSE-Grammar": ["Advanced passive voice and reported speech", "Participle clauses", "Inversion and emphasis"], "DSE-Reading": ["Critical reading of different genres", "Analyzing author's purpose and bias"], "DSE-Writing": ["Persuasive essays", "Proposals and reports", "Problem-solution essays"], "DSE-Speaking": ["Debating skills", "Individual presentation skills"]},
                S6: {"DSE-Exam Skills": ["Paper 1 (Reading) strategies", "Paper 2 (Writing) task analysis", "Paper 3 (Listening) skills", "Paper 4 (Speaking) practice"], "DSE-Advanced Language": ["Nuances in vocabulary", "Idiomatic expressions and phrasal verbs"], "DSE-Integrated Skills": ["Cross-curricular project writing", "Language Arts analysis"]}
            },
            Putonghua: {
                P1: {"漢語拼音": ["單韻母(a,o,e,i,u,ü)", "聲母(b,p,m,f,d,t,n,l)", "聲調(四聲)"], "聽說認讀": ["問候語(你好,謝謝)", "數字(一至十)", "家庭稱謂(爸媽)"]},
                P2: {"漢語拼音": ["聲母(g,k,h,j,q,x)", "複韻母(ai,ei,ui,ao,ou,iu)", "拼讀練習"], "聽說認讀": ["顏色", "食物", "動物", "身體部位"]},
                P3: {"漢語拼音": ["聲母(z,c,s,zh,ch,sh,r)", "前鼻韻母(an,en,in,un,ün)", "三拼音節(jia, qia)"], "聽說認讀": ["天氣", "交通工具", "學校生活"]},
                P4: {"漢語拼音": ["後鼻韻母(ang,eng,ing,ong)", "整體認讀音節(zhi,chi,shi...)", "ü上兩點的省略規則"], "聽說認讀": ["購物", "問路", "節日活動"]},
                P5: {"漢語拼音": ["輕聲現象", "兒化韻", "變調(一/不)"], "聽說認讀": ["興趣愛好", "介紹家鄉", "看病對話"]},
                P6: {"漢語拼音": ["總複習與難點辨析"], "聽說認讀": ["環境保護", "中國文化簡介", "我的夢想"]},
            },
            GeneralStudies: {
                P1: {"健康與生活": ["認識我們的身體", "保持個人衛生", "健康飲食習慣", "情緒的認識與表達", "運動與休息"], "人與環境": ["我的家庭", "我的學校生活", "社區中的人和事", "愛護公物", "天氣與衣著"], "科學與科技": ["常見的動植物", "物料的特性(軟硬、粗滑)"], "國民身份認同與中華文化": ["認識國旗與區旗", "香港的節日"]},
                P2: {"健康與生活": ["飲食金字塔", "遊戲安全", "保護感官", "簡單的急救"], "人與環境": ["社區設施與服務", "鄰里關係", "香港的交通工具", "愛護環境(節約用水、廢物分類)"], "科學與科技": ["水的形態變化", "天氣報告", "光和影", "聲音的產生"], "國民身份認同與中華文化": ["香港的特色地標", "中國傳統節日(農曆新年、中秋節)"]},
                P3: {"健康與生活": ["預防傳染病", "食物的儲存與處理", "選擇健康零食"], "人與環境": ["我們的社區(十八區)", "區議會的角色", "理財入門(消費與儲蓄)"], "科學與科技": ["空氣的特性", "風的形成與風向", "簡單的電路", "磁鐵的特性"], "國民身份認同與中華文化": ["香港簡史(漁村到都市)", "中國的概況(首都、主要城市)"]},
                P4: {"健康與生活": ["青春期(生理心理變化)", "預防家居意外", "運動益處與安全", "選擇健康的飲食模式"], "人與環境": ["香港的政府架構", "香港的經濟發展", "保護水資源", "噪音污染"], "科學與科技": ["植物的生長", "簡單機械(槓桿、滑輪)", "互聯網的應用與安全"], "國民身份認同與中華文化": ["中國的世界遺產", "中國的四大發明"]},
                P5: {"健康與生活": ["善用藥物", "精神健康(壓力處理)", "預防意外(交通、水上安全)", "遠離煙酒和毒品"], "人與環境": ["香港的社會保障", "香港與內地的關係", "全球化的影響", "氣候變化"], "科學與科技": ["資訊與通訊科技的發展", "可再生能源", "生物多樣性"], "國民身份認同與中華文化": ["認識《基本法》", "中國的民族"]},
                P6: {"健康與生活": ["都市病(癌症、心臟病、中風)", "健康的生活方式", "急救知識(續)", "網絡世界的挑戰(沉迷、欺凌)"], "人與環境": ["世界公民的責任", "可持續發展", "國際組織(聯合國、世界衛生組織)"], "科學與科技": ["太空探索", "基因與遺傳", "人工智能簡介"], "國民身份認同與中華文化": ["一國兩制", "國家安全的意義"]}
            }
        };
        const MODEL_FALLBACK_LIST = ["google/gemini-2.0-flash-exp:free", "deepseek/deepseek-r1-0528:free", "google/gemini-2.5-flash-preview-05-20"];
        
        const EXAM_SYSTEM_PROMPT = `你是一位頂尖的香港中小學試卷生成專家，精通 Python 的 'python-docx', 'matplotlib', 'pillow', 'reportlab' 函式庫。
        你的核心任務是根據用戶提供的 JSON 請求，生成一份完整、專業、可立即執行的 Python 腳本，用以創建 DOCX 試卷（及在需要時生成PDF）。
        ## 用戶請求格式
        你將在用戶提示中收到一個 JSON 物件，包含兩大關鍵資訊：
        1. 'scope': 定義考試範圍，包含 'subject', 'grades' (可能是多個), 'knowledge_points'。
        2. 'requirements': 定義題型要求，包含 'template' (如有) 或多個題型及其數量，例如 'single_choice': 5。
        ## 腳本生成規則 (極其重要)
        ### 規則一：模板優先
        - 如果 'requirements.template' 是 'math'，你必須優先生成一份結構類似 **範例 1** 的試卷，包含計算、應用題，並使用 'matplotlib'/'pillow' 生成圖表和答題框。
        - 如果 'requirements.template' 是 'putonghua'，你必須生成類似 **範例 2** 的試卷，包含拼音、配對等題型。**關鍵：你必須同時生成 DOCX 和 PDF 版本。** 在 DOCX 中使用 \`run.bold = True\`，在 PDF 中使用 \`reportlab\` 的疊寫技術模擬中文粗體。
        ### 規則二：自訂題型生成
        若沒有指定模板，則根據 'requirements' 中的具體題型和數量來組合試卷。
        - **single_choice**: 生成5個選項(A-E)，只有一個正確答案。
        - **multi_choice**: 生成5個選項(A-E)，可以有多個正確答案。答案應為一個列表，例如 ['A', 'C']。
        - **fill_in_blank**: 在題目文字中使用 "________" 表示填空處。教師版答案直接填入。
        - **matching**: 生成左右兩列內容。左列帶有 (A), (B)... 標記，右列前方留出 "(__)" 供學生填寫。
        - **short_answer**: 生成問題後，在教師版中，必須提供一個清晰的 'marking_scheme' (評分標準)，列出得分要點及分數。
        - **true_false**: 提供一個陳述句，學生需判斷對錯。
        ### 規則三：嚴格遵守範圍
        所有生成的題目內容，都**必須**嚴格限制在用戶請求的 'scope' 內的知識點，絕不可超出範圍。
        ### 規則四：輸出格式
        你的唯一輸出必須是完整的、可直接執行的 Python 程式碼，並用 \`\`\`python ... \`\`\` 包裹。
        ---
        ## 程式碼生成範例 (Code Generation Examples)
        你必須嚴格參考以下範例的結構、匯入和函式設計。
        ### 範例 1: 數學試卷 (含圖表)
        \`\`\`python
        # -*- coding: utf-8 -*-
        import os
        from docx import Document
        from docx.shared import Pt, Inches
        from docx.enum.text import WD_PARAGRAPH_ALIGNMENT
        from docx.oxml.ns import qn
        import matplotlib.pyplot as plt
        from PIL import Image, ImageDraw
        def generate_bar_chart(path):
            plt.figure()
            plt.savefig(path)
            plt.close()
        def build_math_exam(teacher_mode=False):
            doc = Document()
            section_a_questions = [("1.", "824 ÷ 4", "206")]
            section_c_questions = [("13.", "問題文字...", "答案文字")]
            doc.add_heading("A. 計算題 (24分)", level=1)
            for q_num, q_text, q_ans in section_a_questions:
                p = doc.add_paragraph(f"{q_num} {q_text} = ")
                p.add_run(q_ans if teacher_mode else "________")
            return doc
        if __name__ == "__main__":
            build_math_exam(False).save("math_student.docx")
            build_math_exam(True).save("math_teacher.docx")
            print("數學試卷已生成。")
        \`\`\`
        ### 範例 2: 普通話試卷 (含 PDF 生成)
        \`\`\`python
        # -*- coding: utf-8 -*-
        from docx import Document
        from docx.shared import Pt
        from docx.enum.text import WD_PARAGRAPH_ALIGNMENT
        from docx.oxml.ns import qn
        from reportlab.pdfgen import canvas
        from reportlab.lib.pagesizes import A4
        from reportlab.pdfbase import pdfmetrics
        from reportlab.pdfbase.cidfonts import UnicodeCIDFont
        def pdf_bold(c, text, x, y, size=12):
            pass
        def build_putonghua_docx(teacher_mode=False):
            doc = Document()
            fill_in_blank_data = [("姐姐買的新 ", "鞋", " 子真好看！")]
            doc.add_heading("填空題", level=2)
            for prefix, bold_char, suffix in fill_in_blank_data:
                p = doc.add_paragraph()
                p.add_run(prefix)
                run = p.add_run(bold_char)
                if not teacher_mode: run.bold = True
                p.add_run(suffix + " (____)")
            return doc
        def build_putonghua_pdf(teacher_mode=False):
            c = canvas.Canvas("putonghua_student.pdf", pagesize=A4)
            c.save()
        if __name__ == "__main__":
            build_putonghua_docx(False).save("putonghua_student.docx")
            build_putonghua_docx(True).save("putonghua_teacher.docx")
            build_putonghua_pdf(False)
            print("普通話試卷 (DOCX, PDF) 已生成。")
        \`\`\`
        `;

        // --- DOM Elements & App State ---
        const allSections = document.querySelectorAll('section');
        const configSection = document.getElementById('config-section');
        const loadingSection = document.getElementById('loading-section');
        const examResultSection = document.getElementById('exam-result-section');
        const quizSection = document.getElementById('quiz-section');
        const resultsSection = document.getElementById('results-section');
        const tabButtons = document.querySelectorAll('.tab-btn');
        const tabContents = document.querySelectorAll('.tab-content');
        const kpSubject = document.getElementById('kp-subject');
        const kpGradeContainer = document.getElementById('kp-grade-container');
        const kpMajorContainer = document.getElementById('kp-major-checkboxes');
        const kpMinorContainer = document.getElementById('kp-minor-checkboxes');
        const generateQuizBtn = document.getElementById('generate-quiz-btn');
        const generateExamBtn = document.getElementById('generate-exam-btn');
        const uploadArea = document.getElementById('upload-area');
        const imageUpload = document.getElementById('image-upload');
        const imagePreviewContainer = document.getElementById('image-preview-container');
        const examResultCode = document.getElementById('exam-result-code');
        const copyExamCodeBtn = document.getElementById('copy-exam-code-btn');
        const downloadExamScriptBtn = document.getElementById('download-exam-script-btn');
        const examRestartBtn = document.getElementById('exam-restart-btn');
        const quizRestartBtn = document.getElementById('quiz-restart-btn');
        const exportQuizBtn = document.getElementById('export-quiz-btn');
        const reviewContainer = document.getElementById('review-container');
        const overallScore = document.getElementById('overall-score');
        const quizProgress = document.getElementById('quiz-progress');
        const questionText = document.getElementById('question-text');
        const optionsContainer = document.getElementById('options-container');
        const explanationPanel = document.getElementById('explanation-panel');
        const prevQuestionBtn = document.getElementById('prev-question-btn');
        const nextQuestionBtn = document.getElementById('next-question-btn');
        const finishQuizBtn = document.getElementById('finish-quiz-btn');
        const qTypeItems = document.querySelectorAll('.q-type-item');
        const templateCheckboxes = document.querySelectorAll('.q-type-item.template-item input[type="checkbox"]');
        const customCheckboxes = document.querySelectorAll('.q-type-item:not(.template-item) input[type="checkbox"]');

        let currentTab = 'upload-materials';
        let uploadedFiles = [];
        let quizData = [];
        let currentQuestionIndex = 0;
        let isAnswerRevealed = false;
        
        // --- INITIALIZATION ---
        function init() {
            tabButtons.forEach(button => button.addEventListener('click', () => switchTab(button.dataset.tab)));
            kpSubject.addEventListener('change', populateGradeCheckboxes);
            uploadArea.addEventListener('click', () => imageUpload.click());
            imageUpload.addEventListener('change', (e) => handleFiles(e.target.files));
            uploadArea.addEventListener('dragover', (e) => { e.preventDefault(); uploadArea.style.borderColor = 'var(--primary-dark)'; });
            uploadArea.addEventListener('dragleave', (e) => { e.preventDefault(); uploadArea.style.borderColor = '#42a5f5'; });
            uploadArea.addEventListener('drop', (e) => { e.preventDefault(); e.stopPropagation(); uploadArea.style.borderColor = '#42a5f5'; handleFiles(e.dataTransfer.files); });
            imagePreviewContainer.addEventListener('click', (e) => { if (e.target.classList.contains('remove-image-btn')) { const index = parseInt(e.target.dataset.index, 10); uploadedFiles.splice(index, 1); renderImagePreviews(); updateGenerateButtonState(); } });
            generateQuizBtn.addEventListener('click', () => runGeneration('quiz'));
            generateExamBtn.addEventListener('click', () => runGeneration('exam'));
            copyExamCodeBtn.addEventListener('click', handleCopyCode);
            downloadExamScriptBtn.addEventListener('click', handleDownloadScript);
            examRestartBtn.addEventListener('click', resetApp);
            quizRestartBtn.addEventListener('click', resetApp);
            if(exportQuizBtn) exportQuizBtn.addEventListener('click', handleQuizExport);
            nextQuestionBtn.addEventListener('click', showNextQuestion);
            prevQuestionBtn.addEventListener('click', showPrevQuestion);
            finishQuizBtn.addEventListener('click', showResults);
            
            templateCheckboxes.forEach(chk => chk.addEventListener('change', () => handleTemplateCheckboxChange(chk)));
            customCheckboxes.forEach(chk => chk.addEventListener('change', handleCustomCheckboxChange));

            populateSubjects();
            updateGenerateButtonState();
        }

        // --- UI & DATA HANDLING ---
        function switchTab(tabName) {
            currentTab = tabName;
            tabButtons.forEach(btn => btn.classList.toggle('active', btn.dataset.tab === tabName));
            tabContents.forEach(content => content.classList.toggle('hidden', content.id !== `tab-content-${tabName}`));
            updateGenerateButtonState();
        }

        function populateSubjects() {
            const subjects = Object.keys(KNOWLEDGE_POINTS);
            kpSubject.innerHTML = subjects.map(s => `<option value="${s}">${getSubjectName(s)}</option>`).join('');
            populateGradeCheckboxes();
        }
        
        function populateGradeCheckboxes() {
            const subject = kpSubject.value;
            const grades = Object.keys(KNOWLEDGE_POINTS[subject] || {});
            kpGradeContainer.innerHTML = grades.map(grade => `
                <label class="grade-label" for="grade-${grade}">
                    <input type="checkbox" name="kp-grade" id="grade-${grade}" value="${grade}">
                    ${getGradeName(grade)}
                </label>
            `).join('');
            document.querySelectorAll('input[name="kp-grade"]').forEach(chk => {
                chk.addEventListener('change', (e) => {
                    e.currentTarget.parentElement.classList.toggle('checked');
                    populateMajorKnowledgePoints();
                });
            });
            populateMajorKnowledgePoints();
        }

        function populateMajorKnowledgePoints() {
            const subject = kpSubject.value;
            const selectedGrades = Array.from(document.querySelectorAll('input[name="kp-grade"]:checked')).map(chk => chk.value);
            
            kpMajorContainer.innerHTML = '';
            
            if (selectedGrades.length > 0) {
                selectedGrades.forEach(grade => {
                    const majors = KNOWLEDGE_POINTS[subject][grade] ? Object.keys(KNOWLEDGE_POINTS[subject][grade]) : [];
                    if (majors.length > 0) {
                        const gradeHeading = document.createElement('h5');
                        gradeHeading.className = 'kp-grade-heading';
                        gradeHeading.textContent = getGradeName(grade);
                        kpMajorContainer.appendChild(gradeHeading);

                        majors.forEach(major => {
                            const label = document.createElement('label');
                            label.className = 'kp-label';
                            label.innerHTML = `<input type="checkbox" name="kp-major" value="${major}" data-grade="${grade}"> ${major}`;
                            kpMajorContainer.appendChild(label);
                        });
                    }
                });
            } else {
                 kpMajorContainer.innerHTML = '<p style="color: #888; text-align: center; margin-top: 20px;">請先選擇上方年級</p>';
            }

            populateMinorKnowledgePoints();
            
            document.querySelectorAll('input[name="kp-major"]').forEach(chk => {
                chk.addEventListener('change', () => { populateMinorKnowledgePoints(); updateGenerateButtonState(); });
            });
            updateGenerateButtonState();
        }

        function populateMinorKnowledgePoints() {
            const subject = kpSubject.value;
            const selectedMajors = Array.from(document.querySelectorAll('input[name="kp-major"]:checked'));
            
            let minorsHTML = '';
            if (selectedMajors.length > 0) {
                 selectedMajors.forEach(majorCheckbox => {
                    const major = majorCheckbox.value;
                    const grade = majorCheckbox.dataset.grade;
                    const minors = KNOWLEDGE_POINTS[subject]?.[grade]?.[major] || [];
                    minorsHTML += minors.map(minor => `<label class="kp-label" data-minor-for="${grade}-${major}"><input type="checkbox" name="kp-minor" value="${minor}" checked> ${minor}</label>`).join('');
                });
            } else {
                 minorsHTML = '<p style="color: #888; text-align: center; margin-top: 20px;">請先選擇左方的大類</p>';
            }
            kpMinorContainer.innerHTML = minorsHTML;
            document.querySelectorAll('input[name="kp-minor"]').forEach(chk => chk.addEventListener('change', updateGenerateButtonState));
        }
        
        function handleTemplateCheckboxChange(checkbox) {
            const isChecked = checkbox.checked;
            templateCheckboxes.forEach(otherChk => {
                if (otherChk !== checkbox) otherChk.checked = false;
            });
            qTypeItems.forEach(item => {
                if (!item.classList.contains('template-item')) {
                    const chk = item.querySelector('input[type="checkbox"]');
                    const num = item.querySelector('input[type="number"]');
                    if(isChecked) {
                        item.classList.add('disabled');
                        chk.disabled = true;
                        if(num) num.disabled = true;
                        chk.checked = false;
                    } else {
                        item.classList.remove('disabled');
                        chk.disabled = false;
                         if(num) num.disabled = false;
                    }
                }
            });
        }
        
        function handleCustomCheckboxChange() {
            let anyCustomChecked = Array.from(customCheckboxes).some(chk => chk.checked);
            if(anyCustomChecked) {
                templateCheckboxes.forEach(chk => chk.checked = false);
                qTypeItems.forEach(item => {
                    if (!item.classList.contains('template-item')) {
                        item.classList.remove('disabled');
                        const chk = item.querySelector('input[type="checkbox"]');
                        const num = item.querySelector('input[type="number"]');
                        if(chk) chk.disabled = false;
                        if(num) num.disabled = false;
                    }
                });
            }
        }
        
        function updateGenerateButtonState() {
            const imageModeActive = currentTab === 'upload-materials' && uploadedFiles.length > 0;
            const kpModeActive = currentTab === 'select-knowledge-points' && document.querySelectorAll('input[name="kp-minor"]:checked').length > 0;
            const canGenerate = imageModeActive || kpModeActive;
            generateQuizBtn.disabled = !canGenerate;
            generateExamBtn.disabled = !canGenerate;
        }

        function handleFiles(files) {
            const newFiles = Array.from(files).filter(f => f.type.startsWith('image/'));
            if (uploadedFiles.length + newFiles.length > 20) { alert('最多只能上傳 20 張圖片。'); return; }
            uploadedFiles.push(...newFiles);
            renderImagePreviews();
            updateGenerateButtonState();
        }

        function renderImagePreviews() {
            imagePreviewContainer.innerHTML = '';
            uploadedFiles.forEach((file, index) => {
                const reader = new FileReader();
                reader.onload = e => {
                    const item = document.createElement('div');
                    item.className = 'image-preview-item';
                    item.innerHTML = `<img src="${e.target.result}" alt="${file.name}"><button class="remove-image-btn" data-index="${index}">×</button>`;
                    imagePreviewContainer.appendChild(item);
                };
                reader.readAsDataURL(file);
            });
        }
        
        function showSection(sectionToShow) {
            [configSection, loadingSection, examResultSection, quizSection, resultsSection].forEach(s => {
                if(s) s.classList.add('hidden');
            });
            if (sectionToShow) sectionToShow.classList.remove('hidden');
        }

        function resetApp() {
            uploadedFiles = [];
            quizData = [];
            currentQuestionIndex = 0;
            isAnswerRevealed = false;
            if (imageUpload) imageUpload.value = '';
            renderImagePreviews();
            switchTab('upload-materials');
            populateSubjects();
            updateGenerateButtonState();
            showSection(configSection);
        }

        function getSubjectName(key) {
            const names = { Math: '數學', Chinese: '中文', English: '英文', Putonghua: '普通話', GeneralStudies: '常識' };
            return names[key] || key;
        }
        
        function getGradeName(key) {
             const names = { P1: '小一', P2: '小二', P3: '小三', P4: '小四', P5: '小五', P6: '小六', S1: '中一', S2: '中二', S3: '中三', S4: '中四', S5: '中五', S6: '中六' };
             return names[key] || key;
        }

        function fileToBase64(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = () => resolve(reader.result.split(',')[1]);
                reader.onerror = reject;
                reader.readAsDataURL(file);
            });
        }
        
        // --- API & GENERATION ---
        async function runGeneration(type) {
            showSection(loadingSection);
            let scope, requirements = {}, systemPrompt, responseFormat = null, images = [];
            
            if (currentTab === 'upload-materials') {
                if (uploadedFiles.length === 0) { alert('請先上傳圖片。'); resetApp(); return; }
                images = await Promise.all(uploadedFiles.map(fileToBase64));
                scope = { from_images: true, subject: getSubjectName(kpSubject.value) };
            } else {
                const selectedGrades = Array.from(document.querySelectorAll('input[name="kp-grade"]:checked')).map(chk => chk.value);
                const selectedMinorKPs = Array.from(document.querySelectorAll('input[name="kp-minor"]:checked')).map(chk => chk.value);
                if (selectedMinorKPs.length === 0) { alert('請先選擇至少一個知識點細項。'); resetApp(); return; }
                scope = {
                    subject: getSubjectName(kpSubject.value),
                    grades: selectedGrades.map(getGradeName),
                    knowledge_points: selectedMinorKPs
                };
            }

            const mathTemplate = document.getElementById('chk-math-template').checked;
            const pthTemplate = document.getElementById('chk-putonghua-template').checked;

            if (mathTemplate) {
                requirements.template = 'math';
            } else if (pthTemplate) {
                requirements.template = 'putonghua';
            } else {
                const customReqs = [
                    { id: 'single-choice', numId: 'num-single-choice' },
                    { id: 'multi-choice', numId: 'num-multi-choice' },
                    { id: 'fill-in-blank', numId: 'num-fill-blank' },
                    { id: 'matching', numId: 'num-matching' },
                    { id: 'short-answer', numId: 'num-short-answer' },
                    { id: 'true-false', numId: 'num-true-false' }
                ];
                customReqs.forEach(req => {
                    if (document.getElementById(`chk-${req.id}`).checked) {
                        const num = parseInt(document.getElementById(req.numId).value, 10);
                        if(num > 0) requirements[req.id] = num;
                    }
                });
            }

            const userRequest = JSON.stringify({ scope, requirements }, null, 2);
            
            if (type === 'quiz') {
                systemPrompt = `你是一個互動測驗出題專家。根據用戶請求，生成10條選擇題。**嚴格遵守**用戶指定的範圍。你的唯一輸出必須是單一、合法的JSON物件，格式為 { "questions": [...] }，其中每個問題對象包含 'question', 'options' (A,B,C,D), 'answer', 'explanation', 'tags'。`;
                responseFormat = { type: "json_object" };
            } else { 
                systemPrompt = EXAM_SYSTEM_PROMPT;
            }

            try {
                const result = await callApi(systemPrompt, userRequest, images, responseFormat);
                handleResult(result, type);
            } catch (error) {
                console.error("Generation Error:", error);
                alert(`生成時發生錯誤：${error.message}`);
                resetApp();
            }
        }

        async function callApi(systemPrompt, userPrompt, base64Images = [], responseFormat = null) {
            const delay = ms => new Promise(res => setTimeout(res, ms));
            let retries = 3;
            let currentDelay = 1500;

            for (let i = 0; i <= retries; i++) {
                try {
                    document.getElementById('loading-status').textContent = i === 0 ? "正在聯絡AI..." : `請求頻繁，正在嘗試重新連接 (${i}/${retries})...`;
                    let content = [{ type: "text", text: userPrompt }];
                    if (base64Images.length > 0) {
                        content.push(...base64Images.map(imgBase64 => ({ type: "image_url", image_url: { url: `data:image/jpeg;base64,${imgBase64}` } })));
                    }

                    const payload = { model: MODEL_FALLBACK_LIST[0], messages: [ { role: "system", content: systemPrompt }, { role: "user", content: content } ], max_tokens: 8192 };
                    if (responseFormat) payload.response_format = responseFormat;

                    const response = await fetch("https://aiquiz.ycm927.workers.dev", {
                        method: "POST",
                        headers: { "Content-Type": "application/json" },
                        body: JSON.stringify(payload)
                    });

                    if (response.status === 429 && i < retries) {
                        console.warn(`Rate limit hit. Retrying in ${currentDelay}ms...`);
                        await delay(currentDelay);
                        currentDelay *= 2; // Exponential backoff
                        continue;
                    }

                    if (!response.ok) throw new Error(`API 請求失敗 (${response.status}): ${await response.text()}`);
                    const data = await response.json();
                    if (data?.choices?.[0]?.message?.content) return data.choices[0].message.content;
                    throw new Error("AI 回應的資料格式不正確或為空。");

                } catch (error) {
                    console.error(`Attempt ${i + 1} failed:`, error.message);
                    if (i === retries) throw new Error("所有重試均失敗，請稍後再試。");
                }
            }
        }

        function handleResult(result, type) {
            let cleanResult = result.match(/```(json|python)\s*([\s\S]*?)\s*```/);
            const finalContent = cleanResult ? cleanResult[2] : result;
            
            if (type === 'quiz') {
                try {
                    const parsedData = JSON.parse(finalContent);
                    if (!parsedData.questions || !Array.isArray(parsedData.questions)) throw new Error("Invalid JSON structure");
                    quizData = parsedData.questions.map(q => ({ ...q, userAnswer: null }));
                    startQuiz();
                } catch (e) {
                    console.error("JSON Parsing Error:", e, "Original text:", finalContent);
                    alert("AI 返回的測驗資料格式不正確，無法解析。");
                    resetApp();
                }
            } else {
                examResultCode.textContent = finalContent.trim();
                showSection(examResultSection);
            }
        }
        
        // --- ALL OTHER FUNCTIONS (unchanged) ---
        function startQuiz() {
            currentQuestionIndex = 0;
            isAnswerRevealed = false;
            showSection(quizSection);
            displayQuestion();
        }
        function displayQuestion() {
            isAnswerRevealed = false;
            explanationPanel.classList.add('hidden');
            const q = quizData[currentQuestionIndex];
            quizProgress.textContent = `問題 ${currentQuestionIndex + 1} / ${quizData.length}`;
            questionText.textContent = q.question;
            optionsContainer.innerHTML = '';
            const optionKeys = ['A', 'B', 'C', 'D'];
            const optionsIsArray = Array.isArray(q.options);
            optionKeys.forEach((key, index) => {
                const optionText = optionsIsArray ? q.options[index] : q.options[key];
                if (optionText === undefined) return;
                const optionId = `q${currentQuestionIndex}_${key}`;
                const label = document.createElement('label');
                label.className = 'option-label';
                label.innerHTML = `<input type="radio" name="q${currentQuestionIndex}" id="${optionId}" value="${key}"><span class="option-key">${key}.</span><span>${optionText}</span>`;
                optionsContainer.appendChild(label);
                if (q.userAnswer) {
                    isAnswerRevealed = true;
                    const isCorrect = q.userAnswer.toUpperCase() === q.answer.toUpperCase();
                    if (key === q.answer) label.classList.add('correct');
                    if (key === q.userAnswer && !isCorrect) label.classList.add('incorrect');
                    if (key === q.userAnswer) label.classList.add('selected');
                }
            });
            if(isAnswerRevealed) explanationPanel.classList.remove('hidden');
            optionsContainer.querySelectorAll('.option-label').forEach(label => {
                label.addEventListener('click', () => {
                    if (quizData[currentQuestionIndex].userAnswer) return;
                    selectAnswer(label.querySelector('input').value);
                });
            });
            updateNavigationButtons();
        }
        function selectAnswer(selectedValue) {
            quizData[currentQuestionIndex].userAnswer = selectedValue;
            checkAnswer(selectedValue);
        }
        function checkAnswer(userAnswer) {
            isAnswerRevealed = true;
            const q = quizData[currentQuestionIndex];
            const isCorrect = userAnswer.toUpperCase() === q.answer.toUpperCase();
            optionsContainer.querySelectorAll('.option-label').forEach(label => {
                const optionKey = label.querySelector('input').value;
                if (optionKey === q.answer) label.classList.add('correct');
                if (optionKey === userAnswer && !isCorrect) label.classList.add('incorrect');
                if (optionKey === userAnswer) label.classList.add('selected');
            });
            explanationPanel.innerHTML = `<strong>答案解釋：</strong> ${q.explanation}`;
            explanationPanel.classList.remove('hidden');
            updateNavigationButtons();
        }
        function updateNavigationButtons() {
            prevQuestionBtn.disabled = currentQuestionIndex === 0;
            const isLastQuestion = currentQuestionIndex === quizData.length - 1;
            nextQuestionBtn.classList.toggle('hidden', isLastQuestion);
            finishQuizBtn.classList.toggle('hidden', !isLastQuestion);
        }
        function showNextQuestion() { if (currentQuestionIndex < quizData.length - 1) { currentQuestionIndex++; displayQuestion(); } }
        function showPrevQuestion() { if (currentQuestionIndex > 0) { currentQuestionIndex--; displayQuestion(); } }
        function showResults() {
            showSection(resultsSection);
            let correctAnswers = 0;
            quizData.forEach(q => { if (q.userAnswer && q.userAnswer.toUpperCase() === q.answer.toUpperCase()) correctAnswers++; });
            const scorePercentage = quizData.length > 0 ? (correctAnswers / quizData.length) * 100 : 0;
            overallScore.textContent = `總分: ${correctAnswers} / ${quizData.length} (${scorePercentage.toFixed(1)}%)`;
            reviewContainer.innerHTML = '';
            quizData.forEach((q, index) => {
                const item = document.createElement('div');
                const isCorrect = q.userAnswer && q.userAnswer.toUpperCase() === q.answer.toUpperCase();
                item.className = `review-item ${isCorrect ? 'correct' : 'incorrect'}`;
                const optionsText = q.options ? (Array.isArray(q.options) ? q.options : Object.values(q.options)).map((opt, i) => `${String.fromCharCode(65 + i)}. ${opt}`).join('<br>') : '';
                let userAnswerText = q.userAnswer ? `${q.userAnswer}. ${getOptionText(q, q.userAnswer)}` : '未作答';
                let answerHtml = `<div class="review-answer">你的答案: ${userAnswerText} ${isCorrect ? '✔' : '❌'}</div>`;
                if (!isCorrect) {
                    let correctAnswerText = `${q.answer}. ${getOptionText(q, q.answer)}`;
                    answerHtml += `<div class="review-answer">正確答案: ${correctAnswerText}</div>`;
                }
                item.innerHTML = `<div class="review-question">Q${index + 1}: ${q.question}</div><div style="padding-left: 20px; margin: 10px 0;">${optionsText}</div>${answerHtml}<div class="review-explanation"><strong>解釋:</strong> ${q.explanation}</div>`;
                reviewContainer.appendChild(item);
            });
        }
        function getOptionText(question, key) {
            if (!key || !question.options) return '';
            const normalizedKey = key.toUpperCase();
            if (Array.isArray(question.options)) {
                const index = ['A', 'B', 'C', 'D', 'E'].indexOf(normalizedKey);
                return index > -1 && question.options[index] ? question.options[index] : '';
            }
            return question.options[normalizedKey] || '';
        }
        function handleQuizExport() {
            if (quizData.length === 0) { alert('沒有可導出的測驗。'); return; }
            const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(quizData, null, 2));
            const downloadAnchorNode = document.createElement('a');
            downloadAnchorNode.setAttribute("href", dataStr);
            downloadAnchorNode.setAttribute("download", `ai-quiz_${new Date().toISOString().slice(0,10).replace(/-/g,'')}.json`);
            document.body.appendChild(downloadAnchorNode);
            downloadAnchorNode.click();
            downloadAnchorNode.remove();
        }
        function handleCopyCode() {
            navigator.clipboard.writeText(examResultCode.textContent).then(() => alert('代碼已複製到剪貼簿！'), () => alert('複製失敗。'));
        }
        function handleDownloadScript() {
            const blob = new Blob([examResultCode.textContent], { type: 'text/x-python' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.download = `generate_exam_script_${new Date().toISOString().slice(0,10).replace(/-/g,'')}.py`;
            a.href = url;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }
        document.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>
